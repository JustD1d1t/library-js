// BOOKS

// let books = [
//   {
//     title: "DZIENNIK ANNE FRANK",
//     author: "ANNE FRANK",
//     description:
//       "Uznany za jedno z najwiÄ™kszych dzieÅ‚ literatury Å›wiatowej, pamiÄ™tnik Anne Frank to dokÅ‚adna, nad wyraz dojrzaÅ‚a relacja z ponad dwuletniego ukrywania siÄ™ Anne i caÅ‚ej jej rodziny podczas nazistowskiej okupacji Holandii. Trudno nie czytaÄ‡ â€žDziennikaâ€¦â€ ze smutkiem i swego rodzaju poczuciem straty, gdy wiemy juÅ¼, Å¼e kryjÃ³wkÄ™ zdradzono, a bohaterka zmarÅ‚a w obozie kilka miesiÄ™cy pÃ³Åºniejâ€¦ Lektura trudna przez poczucie nadchodzÄ…cej zagÅ‚ady, a jednoczeÅ›nie przyjemna, bo Anne w bÅ‚yskotliwy sposÃ³b udaÅ‚o siÄ™ opisaÄ‡ te ostatnie lata swojego Å¼ycia.",
//   },
//   {
//     title: "MYÅšL! I BOGAÄ† SIÄ˜",
//     author: "NAPOLEON HILL",
//     description:
//       "Ten napisany w 1937 roku poradnik wciÄ…Å¼ bije na Å›wiecie rekordy popularnoÅ›ci. ChociaÅ¼ moÅ¼e â€žporadnikâ€ to trochÄ™ zbyt uproszczone sÅ‚owo na opisanie tej ksiÄ…Å¼ki. Jest to raczej zachÄ™cenie do pracy i przyjÄ™cie pewnej filozofii sukcesu, dziÄ™ki ktÃ³rej, w przyszÅ‚oÅ›ci, dziÄ™ki ciÄ™Å¼kiej pracy, wysiÅ‚kowi i odpowiedniemu nastawieniu, kaÅ¼dy jest w stanie staÄ‡ siÄ™ dobrze prosperujÄ…cym czÅ‚owiekiem. W kaÅ¼dej dziedzinie Å¼ycia. CoÅ› dla samorozwoju, budowania motywacji i pewnoÅ›ci siebie. Napisane w czasach Wielkiej Depresji, dzisiaj w czasie kryzysu sprawdza siÄ™ jak nigdy dotÄ…d.",
//   },
//   {
//     title: "PRZEMINÄ˜ÅO Z WIATREM",
//     author: "MARGARET MITCHELL",
//     description:
//       "Tej powieÅ›ci pewnie nikomu nie muszÄ™ przedstawiaÄ‡, tym bardziej, Å¼e juÅ¼ wczeÅ›niej do niej zachÄ™caÅ‚am. Dla przypomnienia to peÅ‚na namiÄ™tnoÅ›ci, miÅ‚oÅ›ci i zdrady historia piÄ™knej belle z amerykaÅ„skiego PoÅ‚udnia: Scarlett Oâ€™Hary. A w tle wojna secesyjna, krwawy upadek PoÅ‚udnia, obalenie niewolnictwa i wielkie zmiany, nie tylko dla caÅ‚ych StanÃ³w Zjednoczonych, ale przed wszystkim dla gÅ‚Ã³wnej bohaterki. I jej niezapomniane, kultowe motto: â€žBo jutro teÅ¼ jest dzieÅ„â€.",
//   },
//   {
//     title: "ZMIERZCH",
//     author: "STEPHENIE MEYER",
//     description:
//       "Bardzo chciaÅ‚abym nie pisaÄ‡ o tej pozycji, a raczej pozycjach kilku, bo to przecieÅ¼ cztery porzÄ…dne tomiszcza. Ale najwidoczniej nie mam wyboru ðŸ˜‰ Hit wÅ›rÃ³d mÅ‚odzieÅ¼y. Kultowe powieÅ›ci nastolatkÃ³w. Wampiry kontra wilkoÅ‚aki. Odwieczny konflikt. A w tym wszystkim zagubiona, stÅ‚amszona i ciamajdowata Bella, ktÃ³ra nie moÅ¼e zdecydowaÄ‡ siÄ™ kogo wybraÄ‡, czy bladolicego Edwarda, czy Å›niadego Jacoba. I cierpi. A potem w koÅ„cu wybiera. I jeszcze wiÄ™cej wampirÃ³w i wilkoÅ‚akÃ³w.",
//   },
//   {
//     title: "KOD LEONARDA DA VINCI",
//     author: "DAN BROWN",
//     description:
//       "Jedna z najbardziej popularnych powieÅ›ci ostatnich lat, wciÄ…Å¼ na pierwszym miejscu wÅ›rÃ³d czytelnikÃ³w Wielkiej Brytanii. PeÅ‚en wartkiej akcji, tajemnic i morderstw thriller, ktÃ³rego gÅ‚Ã³wnym bohaterem jest Robert Langdon. Ten historyk, profesor, specjalista od symboli zostaje wplÄ…tany w odwieczny religijny spisek i niczym wspÃ³Å‚czesny rycerz okrÄ…gÅ‚ego stoÅ‚u wyrusza na poszukiwanie ÅšwiÄ™tego Graala. A w tle ParyÅ¼ i oczywiÅ›cie obrazy Leonardo da Vinci. Typowy przykÅ‚ad literatury pop, dla kaÅ¼dego kto nie wymaga zbyt wiele.",
//   },
//   {
//     title: "ALCHEMIK",
//     author: "PAOLO COELHO",
//     description:
//       "Jedna z ksiÄ…Å¼ek, ktÃ³rych rewelacyjnego odbioru zupeÅ‚nie nie rozumiem. Przez wielu uznawana za niesamowitÄ…, peÅ‚nÄ… odwiecznej mÄ…droÅ›ci, ekstremalnie przeÅ‚adowanÄ… filozofiÄ… powieÅ›Ä‡.  W gruncie rzeczy jest wyjÄ…tkowo tanim chwytem na zbolaÅ‚e Å¼yciem serca naiwnych czytelnikÃ³w, zapeÅ‚nionÄ… pustymi â€žrozwaÅ¼aniamiâ€ w stylu: â€žW Å¼yciu boÂ­wiem isÂ­tniejÄ… rzeczy, o ktÃ³re warÂ­to walÂ­czyÄ‡ do saÂ­mego koÅ„caâ€, czy â€žTo oczywiste, Å¼e ludzkoÅ›Ä‡ zdoÅ‚a zachowaÄ‡ moc.â€ Po przeanalizowaniu â€žfilozofiiâ€ Coelho, wyciÄ™ciu nic nieznaczÄ…cych frazesÃ³w zostaje moÅ¼e dziesiÄ™Ä‡ stron sÅ‚abej prozy. Najlepsza dla wciÄ…Å¼ â€žszukajÄ…cych swojej drogi â€ zagubionych gimnazjalistÃ³w, prawdziwa filozofia light, bez kalorii i Å¼adnych wartoÅ›ci odÅ¼ywczych.",
//   },
//   {
//     title: "WÅ‚adca PierÅ›cieni",
//     author: "J.R.R. Tolkien",
//     description:
//       "Pozycja obowiÄ…zkowa. Kultowa powieÅ›Ä‡, ktÃ³ra jest podstawÄ… caÅ‚ego wspÃ³Å‚czesnego fantasy, a sam Tolkien zostaÅ‚ mianowany â€žojcemâ€ gatunku. To on sklasyfikowaÅ‚ elfy, krasnoludy, orkÃ³w i gobliny. To dziÄ™ki niemu po ÅšrÃ³dziemu biegajÄ… hobbity. MoÅ¼na siÄ™ kÅ‚Ã³ciÄ‡ skÄ…d czerpaÅ‚ inspiracje. MoÅ¼na prÃ³bowaÄ‡ ubliÅ¼yÄ‡ jego umiejÄ™tnoÅ›ciom kreowania Å›wiatÃ³w. Ale bez Tolkiena popkultura, w tym filmy, literatura, gry komputerowe, byÅ‚aby o wiele uboÅ¼szaâ€¦ Nawet jeÅ›li dzisiaj staje siÄ™ modne bycie anty-Tolkienem.",
//   },
//   {
//     title: "HARRY POTTER",
//     author: "J.K. ROWLING",
//     description:
//       "Siedem tomÃ³w opowiadajÄ…cych dzieje mÅ‚odego czarodzieja, ktÃ³ry walczy ze swoim odwiecznym wrogiem Voldemortem zmieniÅ‚y Å¼ycie caÅ‚ego pokolenia. Przez lata czekaliÅ›my na kolejne tomy, obawiajÄ…c siÄ™ o ukochanych bohaterÃ³w, razem z nimi przeÅ¼ywajÄ…c rozterki i wykÅ‚Ã³cajÄ…c siÄ™ o przynaleÅ¼noÅ›Ä‡ do domÃ³w Hogwartu. Potem rÃ³wnie dÅ‚ugo czekaliÅ›my na kolejne czÄ™Å›ci ekranizacji. Rowling udaÅ‚o siÄ™ odÅ›wieÅ¼yÄ‡ literaturÄ™ dzieciÄ™cÄ… i mÅ‚odzieÅ¼owÄ…. WprowadziÄ‡ element zapomnianej magii we wspÃ³Å‚czesnoÅ›Ä‡. OdrealniÄ‡ trochÄ™ rzeczywistoÅ›Ä‡. BaÅ›Å„, legenda, thriller i dobrze opowiedziana historia dla maÅ‚ych jak i dla duÅ¼ych czytelnikÃ³w.",
//   },
//   {
//     title: "WYJÄ„TKI Z DZIEÅ PRZEWODNICZÄ„CEGO MAO TSE-TUNGA",
//     author: "MAO TSE-TUNG",
//     description:
//       "Co by tu duÅ¼o pisaÄ‡â€¦ ObowiÄ…zkowa pozycja dla WSZYSTKICH obywateli ChiÅ„skiej Republiki Ludowej. NIE do odrzucenia. NIE do podwaÅ¼enia. Prawie czterdzieÅ›ci lat po Å›mierci Mao wciÄ…Å¼ na szczycie.",
//   },
// ];

//FUNCTION JWT

const email = document.getElementById("email");
const password = document.getElementById("password");
const logoutForm = document.getElementById("logout-form");
const loginForm = document.getElementById("login-form");

function checkTokenExpiration(token) {
  if (token) {
    const expiry = JSON.parse(atob(token.split(".")[1])).exp;
    return Math.floor(new Date().getTime() / 1000) >= expiry;
  }
  return;
}
function parseJwt(token) {
  var base64Url = token.split(".")[1];
  var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
  var jsonPayload = decodeURIComponent(
    atob(base64)
      .split("")
      .map(function (c) {
        return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
      })
      .join("")
  );
  return JSON.parse(jsonPayload);
}

const isTokenExpired = checkTokenExpiration(localStorage.getItem("token"));
if (!isTokenExpired && typeof isTokenExpired !== "undefined") {
  loginForm.classList.add("hide-form");
  logoutForm.classList.remove("hide-form");
  addMyBooksSection();
}

let books;
let borrowButtons = document.querySelectorAll(".borrow-book");
let returnButtons = document.querySelectorAll(".return-book");

function addMyBooksSection() {
  const sectionSelector = document.getElementById("library");
  sectionSelector.innerHTML += `<option value="borrowed">WypoÅ¼yczone ksiÄ…Å¼ki</option>`;
}

async function getBooks() {
  const selectedBooks = document.getElementById("library").value;
  let person;
  if (typeof localStorage.getItem("token") === "string") {
    person = parseJwt(localStorage.getItem("token")).id;
  }
  const response = await fetch("http://localhost:4000/books", {
    method: "POST",
    body: JSON.stringify({
      books: selectedBooks,
      person: person,
    }),
    headers: {
      "Content-Type": "application/json",
    },
  });

  const data = await response.json();
  books = data;
  booksInLibrary.innerHTML = "";
  books.forEach((book) => {
    const newBook = document.createElement("div");
    newBook.classList.add("library__book");
    let template = `<div class="library__book-details"><h4 class="library__book-title">${book.title}</h4><h4 class="library__book-author"> ${book.author}</h4></div><p class="library__book-description clamp-3">${book.description}</p>`;

    if (
      selectedBooks === "available" &&
      localStorage.getItem("token") !== null &&
      !isTokenExpired
    ) {
      template += '<button class="borrow-book">WypoÅ¼ycz ksiÄ…Å¼kÄ™</button>';
    } else if (
      selectedBooks === "borrowed" &&
      localStorage.getItem("token") !== "undefined" &&
      !isTokenExpired
    ) {
      template += '<button class="return-book">Oddaj ksiÄ…Å¼kÄ™</button>';
    }
    newBook.innerHTML = template;
    addBooksToLibrary(newBook);
  });
  borrowButtons = document.querySelectorAll(".borrow-book");
  borrowButtons.forEach((button) => {
    button.addEventListener("click", borrowBook);
  });
  returnButtons = document.querySelectorAll(".return-book");
  returnButtons.forEach((button) => {
    button.addEventListener("click", returnBook);
  });
}
getBooks();
const form = document.getElementById("section-form");
form.addEventListener("submit", (e) => {
  e.preventDefault();
  getBooks();
});
const availableBooksInLibrary = document.querySelector(
  ".library__available-books"
);
const booksInLibrary = document.querySelector(".library__books");

function addBooksToLibrary(book) {
  booksInLibrary.append(book);
}
function addBooksToAvailable(book) {
  availableBooksInLibrary.append(book);
}

//USER

async function login() {
  const response = await fetch("http://localhost:4000/person/login", {
    method: "POST",
    body: JSON.stringify({
      email: email.value,
      password: password.value,
    }),
    headers: {
      "Content-Type": "application/json",
    },
  });
  const data = await response.json();
  if (data.token) {
    localStorage.setItem("token", data.token);
    loginForm.classList.add("hide-form");
    logoutForm.classList.remove("hide-form");
    email.value = "";
    password.value = "";
  }
  addMyBooksSection();
}

function logout() {
  localStorage.removeItem("token");
  loginForm.classList.remove("hide-form");
  logoutForm.classList.add("hide-form");
}

loginForm.addEventListener("submit", (e) => {
  e.preventDefault();
  login();
});

logoutForm.addEventListener("submit", (e) => {
  e.preventDefault();
  logout();
});

const borrowedBooks = document.querySelector(".library__borrowed-books");
const availableBooks = document.querySelector(".library__available-books");

async function borrowBook(e) {
  const tokenData = parseJwt(localStorage.getItem("token"));
  const book = e.target.closest(".library__book");
  const bookTitle = book.querySelector(".library__book-title").textContent;
  book.remove();
  const response = await fetch("http://localhost:4000/books/borrow", {
    method: "POST",
    body: JSON.stringify({
      title: bookTitle,
      person: tokenData.id,
    }),
    headers: {
      "Content-Type": "application/json",
    },
  });
}
async function returnBook(e) {
  const book = e.target.closest(".library__book");
  const bookTitle = book.querySelector(".library__book-title").textContent;
  book.remove();
  const response = await fetch("http://localhost:4000/books/return", {
    method: "POST",
    body: JSON.stringify({
      title: bookTitle,
    }),
    headers: {
      "Content-Type": "application/json",
    },
  });
}
